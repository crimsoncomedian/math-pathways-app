<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Functions — Question 2</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .question{
      padding:1.25rem 1.25rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.05);margin:1rem 0;
    }
    .qtext{font-size:1.05rem;line-height:1.5}
    .answer{margin-top:1rem}
  </style>
</head>
<body>
  <div class="progress"><i style="width:95%"></i></div>

  <main class="container" role="main">
    <h2>Functions — Question 2</h2>
    <p class="sub">This question adapts based on how Question 1 went.</p>

    <div id="qbox" class="question" aria-live="polite">
      <div id="qtext" class="qtext"></div>
      <div class="answer">
        <label for="resp" class="helper">Your answer</label>
        <input id="resp" class="input" autocomplete="off" />
      </div>
    </div>

    <div class="actions" style="justify-content:space-between">
      <button class="btn" type="button" onclick="window.location.href='m3_q1.html'">Back</button>
      <button id="submitBtn" class="btn" type="button">Continue</button>
    </div>
    <p id="msg" class="helper" style="display:none;color:#b91c1c">Please enter an answer.</p>
  </main>

  <script type="module">
    import { getKV, setKV, setProgress } from './js/app.js';
    setProgress(95);

    // --------- Ensure questions list (cache if missing) ---------
    let QUESTIONS = getKV('m3_questions', []);
    if (!Array.isArray(QUESTIONS) || QUESTIONS.length !== 5) {
      QUESTIONS = [
        { id: 'fn1', text: 'List the domain of the function: { (–2, 5), (0, 1), (3, 8), (4, –1) }' },
        { id: 'fn2', text: 'A function is defined as g(x) = 3x − 2. What value of x makes g(x) = 10?' },
        { id: 'fn3', text: 'The relation includes the points: { (1,2), (3,4), (8,b), (7,−5) }. Choose a value for b that would make this relation not a function.' },
        { id: 'fn4', text: 'A ride-share app charges C(d) = 2.25d + 3.75, where C(d) is total cost (dollars) for d miles. Explain what the slope means in this situation.' },
        { id: 'fn5', text: 'Give a real-world example of two different inputs that give the same output from a function.' }
      ];
      setKV('m3_questions', QUESTIONS);
    }

    // --------- Load prior inputs ---------
    const RANK = getKV('m3_ranking', []);         // ['fn1','fn2',...], easiest → hardest
    const CONF = getKV('m3_confidence', {});      // { fn1:'H'|'M'|'L', ... }
    const Q1   = getKV('m3_q1', null);            // { id, text, answer, correct, timeSpent }
    let ASKED  = getKV('m3_asked', []);           // track used IDs

    if (!Q1 || !Array.isArray(RANK) || RANK.length !== 5) {
      window.location.href = 'm3_ranking.html';
    }

    const byId = id => QUESTIONS.find(q => q.id === id);
    const rankIndex = id => RANK.indexOf(id);

    // Build confidence groups in student's rank order
    const H = RANK.filter(id => CONF[id] === 'H');
    const M = RANK.filter(id => CONF[id] === 'M');
    const L = RANK.filter(id => CONF[id] === 'L');

    const currentId   = Q1.id;
    const currentConf = CONF[currentId] || 'M'; // default to M if missing
    const currentIdx  = rankIndex(currentId);

    // Q2 rule: if Q1 correct → go harder; else → go easier (within same confidence group first)
    const wantHarder = Q1.correct === true;
    const dir = wantHarder ? +1 : -1;

    function nextInSameGroup(id){
      const group = currentConf === 'H' ? H : currentConf === 'M' ? M : L;
      const i = group.indexOf(id);
      if (i < 0) return null;
      const j = i + dir;
      if (j < 0 || j >= group.length) return null;
      const cand = group[j];
      return ASKED.includes(cand) ? null : cand;
    }

    function nearestAvailableByRank(){
      const candidates = RANK
        .filter(id => !ASKED.includes(id) && id !== currentId)
        .filter(id => wantHarder ? rankIndex(id) > currentIdx : rankIndex(id) < currentIdx);

      if (!candidates.length) return null;

      let best = null, bestDist = Infinity;
      for (const id of candidates) {
        const d = Math.abs(rankIndex(id) - currentIdx);
        if (d < bestDist) { bestDist = d; best = id; }
      }
      return best;
    }

    // Choose Q2
    let q2Id = nextInSameGroup(currentId) || nearestAvailableByRank();
    if (!q2Id) q2Id = RANK.find(id => !ASKED.includes(id) && id !== currentId) || currentId;

    const q2 = byId(q2Id);
    if (!q2) window.location.href = 'm3_ranking.html';

    // Render
    document.getElementById('qtext').textContent = q2.text;

    // --------- Timing ---------
    const startTime = Date.now();

    // --------- Local grader (same philosophy as m3_q1) ---------
    function norm(s){ return (s ?? '').toString().trim().toLowerCase().replace(/\s+/g,''); }

    function setEqualsDomain(raw, expectedSet){
      const a = norm(raw).replace(/[{}\[\]\(\)]/g,'').replace(/\s/g,'');
      const parts = a.split(/,|;|\s/).filter(Boolean);
      const uniq  = Array.from(new Set(parts));
      if (uniq.length !== expectedSet.length) return false;
      const want = new Set(expectedSet);
      return uniq.every(x => want.has(x));
    }

    function isCorrect(id, raw){
      const a = norm(raw);
      switch(id){
        case 'fn1': // Domain of the set of ordered pairs → {-2, 0, 3, 4}
          return setEqualsDomain(raw, ['-2','0','3','4']);
        case 'fn2': // g(x) = 3x − 2; g(x)=10 → x=4
          return a === '4' || a === 'x=4';
        case 'fn3': // No value of b makes it not a function (x-values are unique)
          return /no\s*value|none|impossible|cannot|no\s*choice/i.test(raw);
        case 'fn4': { // Slope = $2.25 per mile (rate per mile)
          const hasRate = /per\s*mile|each\s*mile|rate/i.test(raw);
          const has225  = /2\.?25/.test(raw);
          const hasCost = /cost|charge|price/i.test(raw);
          return (has225 && hasRate) || (has225 && hasCost);
        }
        case 'fn5': { // Two inputs same output examples (x^2, |x|, constant, etc.)
          const t = a;
          const mentionsSq = /x\^?2|squared/.test(t);
          const mentionsAbs = /\|?x\|?/.test(raw) || /absolute/.test(t);
          const mentionsConst = /constant/.test(t);
          const mentionsTwoInputsSame = /two.*input.*same.*output|same.*y/i.test(t);
          return mentionsSq || mentionsAbs || mentionsConst || mentionsTwoInputsSame;
        }
        default:
          return false;
      }
    }

    // --------- Submit ---------
    const msg = document.getElementById('msg');
    document.getElementById('submitBtn').addEventListener('click', ()=>{
      const input = (document.getElementById('resp').value || '').trim();
      if (!input) { msg.style.display = 'block'; return; }
      msg.style.display = 'none';

      const timeSpent = Math.round((Date.now() - startTime) / 1000);
      const correct   = isCorrect(q2Id, input);

      setKV('m3_q2', {
        id: q2Id,
        text: q2.text,
        answer: input,
        correct,
        timeSpent,
        basedOn: { q1: Q1.id, q1Correct: Q1.correct }
      });

      if (!ASKED.includes(q2Id)) {
        ASKED.push(q2Id);
        setKV('m3_asked', ASKED);
      }

      // Move to Functions reflection
      window.location.href = 'm3_reflection.html';
    });
  </script>
</body>
</html>
