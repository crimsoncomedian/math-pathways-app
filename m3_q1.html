<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Functions – Question 1</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .question{
      padding:1.25rem 1.25rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.04);margin:1rem 0;
    }
    .qtext{font-size:1.05rem;line-height:1.5}
    .answer{margin-top:1rem}
  </style>
</head>
<body>
  <div class="progress"><i style="width:90%"></i></div>

  <main class="container" role="main">
    <h2>Functions — Question 1</h2>
    <p class="sub">This question was selected based on your confidence ratings.</p>

    <div id="qbox" class="question" aria-live="polite">
      <div id="qtext" class="qtext"></div>
      <div class="answer">
        <label for="resp" class="helper">Your answer</label>
        <input id="resp" class="input" autocomplete="off" />
      </div>
    </div>

    <div class="actions" style="justify-content:space-between">
      <button class="btn" type="button" onclick="window.location.href='m3_confidence.html'">Back</button>
      <button id="submitBtn" class="btn" type="button">Continue</button>
    </div>
    <p id="msg" class="helper" style="display:none;color:#b91c1c">Please enter an answer.</p>
  </main>

  <script type="module">
    import { getKV, setKV, setProgress } from './js/app.js';
    setProgress(90);

    // Load context
    const QUESTIONS = getKV('m3_questions', []);   // [{id,text}]
    const RANK      = getKV('m3_ranking', []);     // ['fn1','fn2',...], easiest -> hardest
    const CONF      = getKV('m3_confidence', {});  // { fn1:'H'|'M'|'L', ... }

    if (!Array.isArray(RANK) || RANK.length === 0 || QUESTIONS.length === 0){
      window.location.href = 'm3_ranking.html';
    }

    const byId = id => QUESTIONS.find(q => q.id === id);

    // Build groups by confidence, keeping student's ranked order (easiest -> hardest)
    const H = RANK.filter(id => CONF[id] === 'H');
    const M = RANK.filter(id => CONF[id] === 'M');
    const L = RANK.filter(id => CONF[id] === 'L');

    const pickHardest       = g => g.length ? g[g.length - 1] : null;
    const pickSecondHardest = g => g.length >= 2 ? g[g.length - 2] : null;
    const pickEasiest       = g => g.length ? g[0] : null;
    const pickSecondEasiest = g => g.length >= 2 ? g[1] : null;

    // ---- Pivot selection (your rules) ----
    let q1Id = null;
    if (H.length >= 2){
      // ≥2 High → 2nd-hardest of High-confidence questions
      q1Id = pickSecondHardest(H);
    } else if (H.length >= 1 && M.length >= 1){
      // mix of High & Medium → Hardest High
      q1Id = pickHardest(H);
    } else if (H.length === 0 && M.length >= 1 && L.length === 0){
      // only Medium → Easiest Medium
      q1Id = pickEasiest(M);
    } else if (H.length === 0 && M.length >= 1 && L.length >= 1){
      // Medium + Low → Easiest Medium
      q1Id = pickEasiest(M);
    } else if (H.length === 0 && M.length === 0 && L.length >= 2){
      // only Low → 2nd-easiest Low
      q1Id = pickSecondEasiest(L);
    }
    if (!q1Id){ q1Id = RANK[Math.floor(RANK.length/2)]; } // safety fallback

    const q = byId(q1Id);
    if (!q){ window.location.href = 'm3_ranking.html'; }

    // Render selected question
    document.getElementById('qtext').textContent = q.text;

    // ---- Minimal autograding ----
    function normalize(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,''); }

    // Heuristic checks for conceptual items
    function slopeContextCheck(text){
      const t = normalize(text);
      // look for core ideas: slope as rate, cost per mile, 2.25 per mile
      const hasRate = t.includes('rate') || t.includes('per');
      const hasMile = t.includes('mile') || t.includes('distance') || t.includes('d');
      const has225  = t.includes('2.25') || t.includes('225'); // tolerant
      const hasCost = t.includes('cost') || t.includes('charge') || t.includes('price');
      return (hasRate && hasMile && hasCost) || (has225 && hasMile);
    }

    function sameOutputExampleCheck(text){
      const t = normalize(text);
      // typical valid examples mention squares (2 and -2) or absolute value
      const hasAbs   = t.includes('absolute') || t.includes('|x|');
      const hasSquare= t.includes('square') || t.includes('x^2') || t.includes('squared');
      const mentions2andminus2 = t.includes('2') && t.includes('-2');
      const saysSameOutput = t.includes('sameoutput') || t.includes('sameresult');
      return hasAbs || hasSquare || mentions2andminus2 || saysSameOutput;
    }

    function checkAnswer(id, raw){
      const a = normalize(raw);
      switch(id){
        case 'fn1': {
          // Domain of {(-2,5),(0,1),(3,8),(4,-1)} → {-2,0,3,4}
          // Accept with/without braces/commas/spaces
          const accepted = new Set([
            '{-2,0,3,4}','-2,0,3,4','-2,03,4','-2,3,4,0','{-2, 0, 3, 4}'
          ]);
          if (accepted.has(a)) return true;
          // fallback: parse digits and minus signs
          const nums = a.replace(/[^\d\-\,]/g,'').split(',').map(s=>s.trim()).filter(Boolean);
          const norm = nums.join(',');
          return norm === '-2,0,3,4';
        }
        case 'fn2':
          // g(x)=3x-2, solve g(x)=10 → x=4
          return a === '4' || a === 'x=4';
        case 'fn3':
          // Open response; many teachers will review (the original prompt is tricky for autograde)
          // Accept anything; mark as not auto-graded
          return null; // null = ungraded
        case 'fn4':
          // Slope meaning in C(d)=2.25d+3.75 → $2.25 per mile (rate)
          return slopeContextCheck(raw);
        case 'fn5':
          // Example of two inputs same output (e.g., x^2: 2 and -2)
          return sameOutputExampleCheck(raw);
        default:
          return false;
      }
    }

    const submitBtn = document.getElementById('submitBtn');
    const msg = document.getElementById('msg');
    const resp = document.getElementById('resp');

    submitBtn.addEventListener('click', ()=>{
      const val = resp.value;
      if(!val || !val.trim()){
        msg.style.display = 'block';
        return;
      }
      msg.style.display = 'none';

      const result = checkAnswer(q1Id, val);
      // correct: true/false; ungraded: null
      const correct = (result === null) ? null : !!result;

      setKV('m3_q1', {
        id: q1Id,
        text: q.text,
        answer: val,
        correct
      });

      // Track asked
      const asked = getKV('m3_asked', []);
      if(!asked.includes(q1Id)){
        asked.push(q1Id);
        setKV('m3_asked', asked);
      }

      window.location.href = 'm3_q2.html';
    });
  </script>
</body>
</html>
