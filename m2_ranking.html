<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Equations & Inequalities – Ranking</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <!-- visual-only progress (adjust later as you like) -->
  <div class="progress"><i style="width:72%"></i></div>

  <main class="container" role="main">
    <h2>Equations & Inequalities — Rank the Questions</h2>
    <p class="sub">Drag the questions so the <b>easiest is on top</b> and the <b>hardest on the bottom</b>.</p>

    <ul id="rankList" class="sortable" aria-label="Rank questions from easiest to hardest"></ul>

    <div class="actions" style="justify-content:space-between">
      <button class="btn" type="button" onclick="window.location.href='m1_reflection.html'">Back</button>
      <button id="continueBtn" class="btn" type="button">Continue</button>
    </div>
  </main>

  <script type="module">
    import { setKV, getKV, setProgress } from './js/app.js';
    setProgress(72);

    // Module 2 — Equations & Inequalities (IDs matter for later logic)
    const QUESTIONS = [
      { id:'eq1', text:'Solve for v: v + 6 = 13.' },
      { id:'eq2', text:'Write an inequality using n: a number is at least 10.' },
      { id:'eq3', text:'Solve for p: p − 7 = 4p + 9.' },
      { id:'eq4', text:'Solve for x: (x − 2) / 5 = 3x.' },
      { id:'eq5', text:'Explain: Why do you reverse the inequality when you multiply or divide by a negative?' }
    ];

    const listEl = document.getElementById('rankList');

    // If student returns, respect saved order; else default to listed order
    const savedOrder = getKV('m2_ranking', null);
    const order = (savedOrder && Array.isArray(savedOrder) && savedOrder.length === QUESTIONS.length)
      ? savedOrder
      : QUESTIONS.map(q => q.id);

    const byId = id => QUESTIONS.find(q => q.id === id);

    function render(){
      listEl.innerHTML = '';
      order.forEach((id, idx) => {
        const li = document.createElement('li');
        li.className = 'draggable';
        li.draggable = true;
        li.dataset.id = id;
        li.innerHTML = `
          <span class="badge">${idx+1}</span>
          <span class="qtext">${byId(id).text}</span>
          <span class="handle" aria-hidden="true">⋮⋮</span>
        `;
        listEl.appendChild(li);
      });
    }
    render();

    // Drag & drop behavior
    let dragId = null;
    listEl.addEventListener('dragstart', (e)=>{
      const li = e.target.closest('li.draggable');
      if(!li) return;
      dragId = li.dataset.id;
      li.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    listEl.addEventListener('dragend', (e)=>{
      const li = e.target.closest('li.draggable');
      if(li) li.classList.remove('dragging');
      dragId = null;
      // refresh badges
      [...listEl.children].forEach((li,i)=> li.querySelector('.badge').textContent = i+1);
    });
    listEl.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const after = getDragAfterElement(listEl, e.clientY);
      const dragging = listEl.querySelector('.dragging');
      if(!dragging) return;
      if(after == null) listEl.appendChild(dragging);
      else listEl.insertBefore(dragging, after);
    });

    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('li.draggable:not(.dragging)')];
      return els.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if(offset < 0 && offset > closest.offset){
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Continue → save order and question set, go to confidence page
    document.getElementById('continueBtn').addEventListener('click', ()=>{
      const ids = [...listEl.querySelectorAll('li')].map(li => li.dataset.id);
      setKV('m2_ranking', ids);     // easiest → hardest
      setKV('m2_questions', QUESTIONS);
      window.location.href = 'm2_confidence.html';
    });
  </script>
</body>
</html>
