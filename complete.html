<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Submit Your Answers</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 2rem;
    }

    .progress {
      background: #eee;
      height: 6px;
      margin-bottom: 1.5rem;
    }

    .progress i {
      display: block;
      background: #4f46e5;
      height: 100%;
    }

    main.container {
      background: white;
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem 2.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    h2 {
      font-size: 1.75rem;
      margin-bottom: 1rem;
    }

    .summary {
      font-size: 1rem;
      margin-bottom: 2rem;
      line-height: 1.5;
    }

    button {
      padding: 0.75rem 1.5rem;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 100%;
    }

    button:hover {
      background: #3730a3;
    }

    .section {
      margin-bottom: 1.25rem;
    }

    .section h3 {
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }

    .question-block {
      background: #f3f4f6;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <div class="progress"><i style="width:100%"></i></div>

  <main class="container">
    <h2>You're All Done!</h2>
    <p class="summary">Take one last look at your work before submitting it to your teacher.</p>

    <div class="section" id="summary"></div>

    <button id="submitBtn">Submit All Answers</button>
  </main>

  <script type="module">
    import { getKV } from './js/app.js';

    const moduleId = getKV('current_module') || 'M1';
    const summaryDiv = document.getElementById('summary');

    const ranked = getKV(`${moduleId}_rank`, []);
    const questions = getKV(`${moduleId}_questions`, []);
    const confidence = getKV(`${moduleId}_confidence`, {});
    const q1Index = getKV(`q1_index`);
    const q1Answer = getKV(`q1_answer`);
    const q2Index = getKV(`q2_index`);
    const q2Answer = getKV(`q2_answer`);
    const reflection = getKV(`${moduleId}_reflection`);

    function renderMath(content) {
      return content.replace(/\$(.*?)\$/g, (_, expr) => `\\(${expr}\\)`);
    }

    function addSection(title, content) {
      const wrapper = document.createElement('div');
      wrapper.className = 'section';
      wrapper.innerHTML = `<h3>${title}</h3>${content}`;
      summaryDiv.appendChild(wrapper);
    }

    if (questions.length && ranked.length) {
      const list = ranked.map((id, i) => {
        const q = questions.find(q => q.id === id);
        return `<div class="question-block">
          <strong>#${i + 1}:</strong> ${renderMath(q.label || q.id)}
        </div>`;
      }).join('');
      addSection('Your Ranked Questions (Easiest ‚Üí Hardest)', list);
    }

    if (confidence && Object.keys(confidence).length) {
      const list = ranked.map((id, i) => {
        const q = questions.find(q => q.id === id);
        const val = confidence[id] === 3 ? 'üòÑ Very' :
                    confidence[id] === 2 ? 'üòê Somewhat' :
                    'üòï Not confident';
        return `<div class="question-block">
          <strong>#${i + 1}:</strong> ${renderMath(q.label || q.id)}<br/>
          Confidence: ${val}
        </div>`;
      }).join('');
      addSection('Your Confidence Ratings', list);
    }

    if (q1Index !== null && questions[q1Index]) {
      const q1 = questions[q1Index];
      addSection('Question 1 Answer', `
        <div class="question-block">
          ${renderMath(q1.label || q1.id)}<br/>
          <strong>Your Answer:</strong> ${q1Answer ?? '(no answer)'}
        </div>`);
    }

    if (q2Index !== null && questions[q2Index]) {
      const q2 = questions[q2Index];
      addSection('Question 2 Answer', `
        <div class="question-block">
          ${renderMath(q2.label || q2.id)}<br/>
          <strong>Your Answer:</strong> ${q2Answer ?? '(no answer)'}
        </div>`);
    }

    if (reflection?.difficulty) {
      addSection('Reflection', `
        <div class="question-block">
          <strong>Difficulty:</strong> ${reflection.difficulty}<br/>
          <strong>Comment:</strong> ${reflection.explain || '(no explanation)'}
        </div>`);
    }

    document.getElementById('submitBtn').addEventListener('click', () => {
      // TODO: Handle submission logic (e.g., send to Google Sheets or backend)
      alert("Your answers have been submitted! (Functionality coming soon)");
    });

    if (window.MathJax?.typesetPromise) {
      MathJax.typesetPromise([summaryDiv]).catch(() => {});
    }
  </script>
</body>
</html>
