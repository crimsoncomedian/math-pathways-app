<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Polynomials — Question 1</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .question{
      padding:1.25rem 1.25rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.04);margin:1rem 0;
    }
    .qtext{font-size:1.05rem;line-height:1.5}
    .answer{margin-top:1rem}
  </style>
</head>
<body>
  <div class="progress"><i style="width:90%"></i></div>

  <main class="container" role="main">
    <h2>Polynomials — Question 1</h2>
    <p class="sub">This question was selected based on your rankings and confidence.</p>

    <div id="qbox" class="question" aria-live="polite">
      <div id="qtext" class="qtext"></div>
      <div class="answer">
        <label for="resp" class="helper">Your answer</label>
        <input id="resp" class="input" autocomplete="off" />
      </div>
    </div>

    <div class="actions" style="justify-content:space-between">
      <button class="btn" type="button" onclick="window.location.href='m4_confidence.html'">Back</button>
      <button id="submitBtn" class="btn" type="button">Continue</button>
    </div>
    <p id="msg" class="helper" style="display:none;color:#b91c1c">Please enter an answer.</p>
  </main>

  <script type="module">
    import { getKV, setKV, setProgress } from './js/app.js';
    setProgress(90);

    // -------- Canonical questions (cache if missing) --------
    let QUESTIONS = getKV('m4_questions', []);
    if (!Array.isArray(QUESTIONS) || QUESTIONS.length !== 5) {
      QUESTIONS = [
        { id: 'poly1', text: 'Identify the degree of the polynomial: 4x^3 + 2x^2 − 7x + 6.' },
        { id: 'poly2', text: 'Multiply: (x + 2)(x − 5).' },
        { id: 'poly3', text: 'How would changing the value of 3 to a negative number in f(x) = 3x^2 + 5x + 1 affect the graph of the function?' },
        { id: 'poly4', text: 'Factor: 6x^2 + 11x + 3.' },
        { id: 'poly5', text: 'Name any factor of the polynomial x^3 + x^2 − 14x − 24.' }
      ];
      setKV('m4_questions', QUESTIONS);
    }

    // -------- Load prior inputs --------
    const RANK = getKV('m4_ranking', []);     // ['poly1',...], easiest → hardest
    const CONF = getKV('m4_confidence', {});  // { poly1:'H'|'M'|'L', ... }
    if (!Array.isArray(RANK) || RANK.length !== 5) {
      window.location.href = 'm4_ranking.html';
    }
    const byId = id => QUESTIONS.find(q => q.id === id);

    // Confidence groups in student's rank order
    const H = RANK.filter(id => CONF[id] === 'H');
    const M = RANK.filter(id => CONF[id] === 'M');
    const L = RANK.filter(id => CONF[id] === 'L');

    const pickHardest        = g => g.length ? g[g.length - 1] : null;
    const pickSecondHardest  = g => g.length >= 2 ? g[g.length - 2] : null;
    const pickEasiest        = g => g.length ? g[0] : null;
    const pickSecondEasiest  = g => g.length >= 2 ? g[1] : null;

    // -------- Pivot selection rules (Q1) --------
    let q1Id =
      (H.length >= 2 && pickSecondHardest(H)) ||
      ((H.length >= 1 && M.length >= 1) && pickHardest(H)) ||
      ((H.length === 0 && M.length >= 1 && L.length === 0) && pickEasiest(M)) ||
      ((H.length === 0 && M.length >= 1 && L.length >= 1) && pickEasiest(M)) ||
      ((H.length === 0 && M.length === 0 && L.length >= 2) && pickSecondEasiest(L)) ||
      RANK[Math.floor(RANK.length/2)]; // safety fallback

    const q = byId(q1Id);
    if (!q) { window.location.href = 'm4_ranking.html'; }

    // Render selected problem
    document.getElementById('qtext').textContent = q.text;

    // -------- Timing --------
    const startTime = Date.now();

    // -------- Local autograder --------
    function norm(s){ return (s ?? '').toString().trim().toLowerCase().replace(/\s+/g,''); }

    function isCorrect(id, raw){
      const a = norm(raw);
      switch(id){
        case 'poly1': {
          // degree 3
          return a === '3' || a === 'degree3' || a === 'deg3' || /degree:?3/.test(a);
        }
        case 'poly2': {
          // (x+2)(x−5) = x^2 − 3x − 10
          return a === 'x^2-3x-10' || a === 'x2-3x-10' || a.replace(/\s/g,'') === 'x^2-3x-10';
        }
        case 'poly3': {
          // Changing leading 3 to negative flips the parabola to open downward (reflection over x-axis).
          const t = a;
          const mentionsDown  = /open[s]?down|concave\s*down/.test(t);
          const mentionsFlip  = /reflect|flip|inver/.test(t);
          const mentionsNegA  = /a<0|negativecoefficient|negativ[e]?\s*leading/.test(t);
          return mentionsDown || (mentionsFlip && /x-?axis/.test(t)) || mentionsNegA;
        }
        case 'poly4': {
          // 6x^2 + 11x + 3 = (3x + 1)(2x + 3)
          const b = a.replace(/\s/g,'');
          return /\(3x\+1\)\(2x\+3\)/.test(b) || /\(2x\+3\)\(3x\+1\)/.test(b);
        }
        case 'poly5': {
          // x^3 + x^2 − 14x − 24 factors: (x − 4)(x + 2)(x + 3)
          // Accept any single factor in linear form or named plainly.
          const t = a.replace(/\s/g,'');
          return t === 'x-4' || t === '(x-4)' || t === 'x+2' || t === '(x+2)' || t === 'x+3' || t === '(x+3)';
        }
        default:
          return false;
      }
    }

    // -------- Submit --------
    const msg  = document.getElementById('msg');
    const resp = document.getElementById('resp');
    document.getElementById('submitBtn').addEventListener('click', ()=>{
      const val = (resp.value || '').trim();
      if (!val) { msg.style.display = 'block'; return; }
      msg.style.display = 'none';

      const timeSpent = Math.round((Date.now() - startTime) / 1000);
      const correct   = isCorrect(q1Id, val);

      setKV('m4_q1', {
        id: q1Id,
        text: q.text,
        answer: val,
        correct,
        timeSpent
      });

      // Track asked to avoid repeats
      const asked = getKV('m4_asked', []);
      if (!asked.includes(q1Id)) {
        asked.push(q1Id);
        setKV('m4_asked', asked);
      }

      // Next: adaptive Q2
      window.location.href = 'm4_q2.html';
    });
  </script>
</body>
</html>
