<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Functions ‚Äì Confidence</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .key {
      background:#f7f8fc; border:1px solid #e5e7eb; padding:.75rem 1rem;
      border-radius:10px; display:flex; gap:16px; justify-content:center; align-items:center;
      margin-bottom:1rem; color:#374151; font-size:.95rem;
    }
    .conf-list{display:flex; flex-direction:column; gap:.75rem; margin-top:1rem}
    .conf-row{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      padding:.85rem 1rem; background:#fff; border:1px solid #e5e7eb; border-radius:12px;
    }
    .qtext{flex:1; font-size:15px; margin-right:.75rem}
    .choices{display:flex; gap:12px; flex-shrink:0}
    .emo-btn{
      font-size:20px; background:none; border:none; cursor:pointer; line-height:1;
      transition:transform .15s ease;
    }
    .emo-btn[aria-pressed="true"]{ transform:scale(1.25); }
    .actions{display:flex; justify-content:space-between; margin-top:20px}
    .helper.small{font-size:.85rem}
  </style>
</head>
<body>
  <div class="progress"><i style="width:80%"></i></div>

  <main class="container" role="main">
    <h2>How confident do you feel about each problem?</h2>
    <p class="sub">Choose one confidence level for each question.</p>

    <!-- Key only; no labels on per-question buttons -->
    <div class="key" aria-hidden="true">
      <strong>Confidence key:</strong>
      <span>üòü Not confident</span>
      <span>üòê Somewhat</span>
      <span>üôÇ Very confident</span>
    </div>

    <div id="confList" class="conf-list" aria-live="polite"></div>

    <div class="actions">
      <button class="btn" type="button" onclick="window.location.href='m3_ranking.html'">Back</button>
      <button id="continueBtn" class="btn" type="button" disabled>Continue</button>
    </div>

    <p id="msg" class="helper small" style="display:none;color:#b91c1c">Please select a confidence level for every question.</p>
  </main>

  <script type="module">
    import { getKV, setKV, setProgress } from './js/app.js';
    setProgress(80);

    const QUESTIONS = getKV('m3_questions', []);
    const order     = getKV('m3_ranking', []) || QUESTIONS.map(q=>q.id);
    const saved     = getKV('m3_confidence', {}); // { fn1:'H'|'M'|'L' }

    const confList = document.getElementById('confList');
    const continueBtn = document.getElementById('continueBtn');
    const msg = document.getElementById('msg');

    if (!Array.isArray(order) || order.length === 0 || QUESTIONS.length === 0){
      window.location.href = 'm3_ranking.html';
    }

    const byId = id => QUESTIONS.find(q => q.id === id);

    const EMOJIS = [
      { key:'L', icon:'üòü' },
      { key:'M', icon:'üòê' },
      { key:'H', icon:'üôÇ' }
    ];

    function render(){
      confList.innerHTML = '';
      order.forEach(id => {
        const q = byId(id);
        const row = document.createElement('div');
        row.className = 'conf-row';
        row.dataset.id = id;

        const qtext = document.createElement('div');
        qtext.className = 'qtext';
        qtext.textContent = q.text;

        const choices = document.createElement('div');
        choices.className = 'choices';

        EMOJIS.forEach(opt => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'emo-btn';
          btn.setAttribute('role','radio');
          btn.setAttribute('aria-label', `${opt.key} for: ${q.text}`);
          btn.setAttribute('aria-pressed', saved[id] === opt.key ? 'true' : 'false');
          btn.dataset.id = id;
          btn.dataset.val = opt.key;
          btn.textContent = opt.icon;
          btn.addEventListener('click', ()=>{
            saved[id] = opt.key;
            setKV('m3_confidence', saved);
            // update pressed state for this row
            [...choices.querySelectorAll('.emo-btn')].forEach(b => b.setAttribute('aria-pressed','false'));
            btn.setAttribute('aria-pressed','true');
            validate();
          });
          choices.appendChild(btn);
        });

        row.appendChild(qtext);
        row.appendChild(choices);
        confList.appendChild(row);
      });
    }

    function validate(){
      const allAnswered = order.every(id => saved[id] === 'H' || saved[id] === 'M' || saved[id] === 'L');
      continueBtn.disabled = !allAnswered;
      msg.style.display = allAnswered ? 'none' : 'block';
    }

    continueBtn.addEventListener('click', ()=>{
      if (continueBtn.disabled) return;
      setKV('m3_confidence', saved);
      window.location.href = 'm3_q1.html';
    });

    render();
    validate();
  </script>
</body>
</html>
